name: Hourly Knack Sync (Backup)

on:
  schedule:
    # Run every hour at the top of the hour (backup for Vercel cron)
    # Format: minute hour day month day-of-week
    # This runs at 00:00, 01:00, 02:00, etc. UTC
    - cron: '0 * * * *'

  # Allow manual trigger from Actions tab
  workflow_dispatch:

  # Allow external triggers via workflow_run
  workflow_run:
    workflows: ["Manual Sync Trigger"]
    types: [requested]

jobs:
  sync:
    name: Sync Knack to Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Only run if repo is not a fork (prevent unauthorized syncs)
    if: github.repository == 'YOUR_GITHUB_ORG/hubdash'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log sync info
        run: |
          echo "Starting Knack → Supabase sync"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Trigger: ${{ github.event_name }}"

      - name: Trigger sync endpoint
        id: sync
        run: |
          RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "User-Agent: GitHub-Actions/HubDash-Sync" \
            -H "X-GitHub-Event: schedule" \
            "${{ secrets.DEPLOYMENT_URL }}/api/sync")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          # Extract summary from response
          TOTAL_SYNCED=$(echo "$RESPONSE" | jq '.totalRecordsSynced // 0' 2>/dev/null || echo "unknown")
          TOTAL_ERRORS=$(echo "$RESPONSE" | jq '.totalErrors // 0' 2>/dev/null || echo "unknown")

          echo "total_synced=$TOTAL_SYNCED" >> $GITHUB_OUTPUT
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT

      - name: Check sync status
        id: status
        run: |
          RESPONSE='${{ steps.sync.outputs.response }}'
          TOTAL_ERRORS=$(echo "$RESPONSE" | jq '.totalErrors // 0' 2>/dev/null || echo "0")

          if [ "$TOTAL_ERRORS" == "0" ] || [ "$TOTAL_ERRORS" -lt 5 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Sync completed successfully"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "message=Sync completed with errors: $TOTAL_ERRORS"
          fi

      - name: Report success
        if: steps.status.outputs.status == 'success'
        run: |
          echo "Sync Results:"
          echo "- Records synced: ${{ steps.sync.outputs.total_synced }}"
          echo "- Errors: ${{ steps.sync.outputs.total_errors }}"
          echo "- Status: SUCCESS"

      - name: Report issues
        if: steps.status.outputs.status == 'warning'
        run: |
          echo "Sync Results:"
          echo "- Records synced: ${{ steps.sync.outputs.total_synced }}"
          echo "- Errors: ${{ steps.sync.outputs.total_errors }}"
          echo "- Status: WARNING - Check logs"
          exit 0  # Don't fail the action, just warn

      - name: Create GitHub Issue on critical failure
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Sync failed: Knack → Supabase',
              body: `
              ## Sync Failure

              **Time**: ${new Date().toISOString()}
              **Trigger**: Scheduled hourly sync
              **Status**: FAILED

              ### Action Required
              1. Check deployment logs: https://vercel.com/dashboard
              2. Verify Knack API credentials
              3. Check Supabase status
              4. Manual trigger: \`/api/cron/sync\`

              ### Details
              - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              - Branch: ${{ github.ref }}
              `,
              labels: ['sync', 'critical']
            })

      - name: Notify Slack on failure
        if: failure() && github.event_name == 'schedule'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "HubDash Sync Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *HubDash Knack Sync Failed*\n\n*Time*: <!date^${{ env.TIMESTAMP }}^{date_num} {time_secs}|failed>\n*Status*: FAILED\n*Action*: Check <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|workflow logs>"
                  }
                }
              ]
            }
        continue-on-error: true  # Don't fail if Slack is not configured

---

# Manual Sync Trigger Workflow
# This workflow allows manual triggering of sync from the Actions tab

name: Manual Sync Trigger

on:
  workflow_dispatch:
    inputs:
      table:
        description: 'Table to sync (all, devices, donations)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - devices
          - donations

jobs:
  manual-sync:
    name: Manual Knack Sync
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Trigger manual sync
        id: sync
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Actions/HubDash-ManualSync" \
            -d '{"table": "${{ github.event.inputs.table }}"}' \
            "${{ secrets.DEPLOYMENT_URL }}/api/sync")

          echo "response=$RESPONSE" >> $GITHUB_OUTPUT
          echo "$RESPONSE" | jq '.'

      - name: Report results
        run: |
          RESPONSE='${{ steps.sync.outputs.response }}'
          echo "Manual Sync Results:"
          echo "$RESPONSE" | jq '{
            timestamp: .timestamp,
            totalRecordsSynced: .totalRecordsSynced,
            totalErrors: .totalErrors,
            syncDuration: .syncDuration,
            results: .results
          }'
